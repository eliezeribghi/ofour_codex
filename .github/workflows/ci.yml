name: check ofour
run-name: ${{ github.actor }}

on:
  workflow_dispatch:  
    inputs:
      branch_name:
        description: 'Workflow test'  
        required: true  
        default: 'sonarqube'
      tags:
        description: 'Test'

  push:
    branches:
      - github-actions  

jobs:
  build-container:
    runs-on: ubuntu-latest
    steps:
      - name: Cloner le dépôt
        uses: actions/checkout@v4

      - name: Installer Docker Compose
        run: |
         sudo apt-get update
         sudo apt-get install -y docker-compose

      - name: Démarrer les conteneurs Docker
        run: docker-compose up -d

      - name: Attendre que les conteneurs backend, frontend et MySQL soient prêts
        run: |
          echo "Vérification du démarrage des conteneurs..."
          
          CONTAINERS=("backend_container" "frontend_container" "mysql_db")

          all_ready=false

          while [ "$all_ready" = false ]; do
            all_ready=true  # On suppose que tous sont prêts

            for CONTAINER in "${CONTAINERS[@]}"; do
              if [ -z "$(docker ps --filter "name=$CONTAINER" --filter "status=running" -q)" ]; then
                echo "$CONTAINER n'est pas encore prêt, on attend..."
                all_ready=false  # Au moins un conteneur n'est pas prêt
              fi
            done

            sleep 2
          done

          echo "Tous les conteneurs sont prêts !"

      - name: Tester le Frontend dans son conteneur
        run: |
          docker exec frontend_container  npm run dev & sleep 5

      

      - name: Tester `php artisan serve` à l'intérieur du conteneur backend
        run: |
          docker exec backend_container php artisan serve & sleep 5
      - name: Récupérer l'IP publique
        run: |
         STATUS_CODE=0
        


          CONTAINER_NAME="frontend_container"
          IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $CONTAINER_NAME)

           while [ "$STATUS_CODE" -ne 200 ]; do
            STATUS_CODE=$(curl -L -o /dev/null -s -w "%{http_code}" http://$IP:5173/)
             echo "En attente du serveur... (Status: $STATUS_CODE)"
             sleep 2
           done

           echo "Le serveur est prêt !"
      - name: Vérifier si MySQL est en cours d'exécution et exécuter la requête SQL
        run: |
             
             
             # Exécuter une requête SQL et récupérer une recette
             RECETTE=$(docker exec mysql_db mysql -u root -proot -D "ofour" -e "SELECT * FROM recettes WHERE id = 1;" -s -N)
             
             # Vérifier si la requête a renvoyé un résultat
             if [ -z "$RECETTE" ]; then
               echo "Aucune recette trouvée avec cet ID."
             else
               echo "Recette récupérée : $RECETTE"
             fi
         
         
      - name: Arrêter Docker Compose après les tests
        run: docker-compose down